name: Tests

on:
  workflow_call:

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose

      - name: Setup test environment
        run: |
          # Set test variables
          cp .env.test.example .env.test

          # Start test services
          make test-up

          # Wait for Postgres
          echo "Waiting for Postgres..."
          until docker exec test-postgres-1 pg_isready -U test_user -d test_db; do
            sleep 2
          done

          # Wait for Valkey
          echo "Waiting for Valkey..."
          until docker exec test-valkey-1 valkey-cli -p 6379 ping | grep -q PONG; do
            sleep 1
          done

          echo "All services are ready"

      - name: Run tests
        run: |
          make test
